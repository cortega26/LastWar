name: Lighthouse CI

on:
  pull_request:
    branches: [ main, master ]
    paths:
      - '**/*.html'
      - '**/*.css' 
      - '**/*.js'
      - 'assets/**/*'
  push:
    branches: [ main, master ]
  schedule:
    # Run weekly performance check on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: |
          npm install -g @lhci/cli@0.12.x
          npm install -g http-server
          
      - name: Build site (if needed)
        run: |
          # For static site, just verify structure
          ls -la
          
      - name: Run Lighthouse CI
        run: |
          # Start local server for testing
          http-server . -p 3000 -c-1 --silent &
          sleep 5
          
          # Run Lighthouse CI
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          
      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30
          
      - name: Comment PR with Lighthouse results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Read Lighthouse results
            const resultsPath = '.lighthouseci';
            if (fs.existsSync(resultsPath)) {
              const manifestPath = path.join(resultsPath, 'manifest.json');
              if (fs.existsSync(manifestPath)) {
                const manifest = JSON.parse(fs.readFileSync(manifestPath, 'utf8'));
                
                let comment = '## 🔍 Lighthouse CI Results\n\n';
                
                manifest.forEach(result => {
                  const url = result.url.replace('http://localhost:3000', '');
                  const summary = result.summary;
                  
                  comment += `### ${url || 'Homepage'}\n`;
                  comment += `- **Performance**: ${Math.round(summary.performance * 100)}/100\n`;
                  comment += `- **Accessibility**: ${Math.round(summary.accessibility * 100)}/100\n`;
                  comment += `- **Best Practices**: ${Math.round(summary['best-practices'] * 100)}/100\n`;
                  comment += `- **SEO**: ${Math.round(summary.seo * 100)}/100\n\n`;
                  
                  // Add Core Web Vitals if available
                  if (result.audits) {
                    comment += '**Core Web Vitals:**\n';
                    if (result.audits['largest-contentful-paint']) {
                      comment += `- LCP: ${Math.round(result.audits['largest-contentful-paint'].numericValue)}ms\n`;
                    }
                    if (result.audits['cumulative-layout-shift']) {
                      comment += `- CLS: ${result.audits['cumulative-layout-shift'].numericValue.toFixed(3)}\n`;
                    }
                    if (result.audits['total-blocking-time']) {
                      comment += `- TBT: ${Math.round(result.audits['total-blocking-time'].numericValue)}ms\n`;
                    }
                    comment += '\n';
                  }
                });
                
                comment += '---\n*Lighthouse CI automated performance check*';
                
                github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: comment
                });
              }
            }